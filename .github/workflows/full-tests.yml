name: CI â€” Full Tests (Main)

on:
  push:
    branches:
      - main

env:
  MAVEN_OPTS: -Xmx1g -Xms512m
  MAVEN_ARGS_BUILD: -B -T 1 -V -Dmaven.test.redirectTestOutputToFile=true -Dsurefire.parallel=none -Dfailsafe.parallel=none

jobs:
  ##################################################################
  # Single job that builds, tests, creates coverage reports,
  # runs integration tests with Docker, and builds native images
  ##################################################################
  full-test-suite:
    name: Full Test Suite
    runs-on: ubuntu-latest

    # Skip this workflow when commits are from maven-release-plugin
    if: ${{ !contains(github.event.head_commit.message, 'maven-release-plugin') }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure Maven
        run: echo "MAVEN_ARGS=${{ env.MAVEN_ARGS_BUILD }} --no-transfer-progress" >> $GITHUB_ENV

      - name: Full clean install (framework + examples)
        run: ./mvnw $MAVEN_ARGS clean install -DskipITs=true -DskipNative=true -Dquarkus.container-image.build=false -Dquarkus.package.type=fast-jar

      # Build Docker images using docker/build-push-action for all CSV Payments modules
      - name: Build persistence-svc Docker image
        uses: docker/build-push-action@v6
        with:
          context: examples/csv-payments/persistence-svc
          file: examples/csv-payments/persistence-svc/src/main/docker/Dockerfile.jvm
          tags: localhost/csv-payments/persistence-svc:latest
          load: true

      - name: Build input-csv-file-processing-svc Docker image
        uses: docker/build-push-action@v6
        with:
          context: examples/csv-payments/input-csv-file-processing-svc
          file: examples/csv-payments/input-csv-file-processing-svc/src/main/docker/Dockerfile.jvm
          tags: localhost/csv-payments/input-csv-file-processing-svc:latest
          load: true     # important: makes image available to Testcontainers

      - name: Build payment-status-svc Docker image
        uses: docker/build-push-action@v6
        with:
          context: examples/csv-payments/payment-status-svc
          file: examples/csv-payments/payment-status-svc/src/main/docker/Dockerfile.jvm
          tags: localhost/csv-payments/payment-status-svc:latest
          load: true

      - name: Build payments-processing-svc Docker image
        uses: docker/build-push-action@v6
        with:
          context: examples/csv-payments/payments-processing-svc
          file: examples/csv-payments/payments-processing-svc/src/main/docker/Dockerfile.jvm
          tags: localhost/csv-payments/payments-processing-svc:latest
          load: true

      - name: Build output-csv-file-processing-svc Docker image
        uses: docker/build-push-action@v6
        with:
          context: examples/csv-payments/output-csv-file-processing-svc
          file: examples/csv-payments/output-csv-file-processing-svc/src/main/docker/Dockerfile.jvm
          tags: localhost/csv-payments/output-csv-file-processing-svc:latest
          load: true

      - name: Build orchestrator-svc Docker image
        uses: docker/build-push-action@v6
        with:
          context: examples/csv-payments/orchestrator-svc
          file: examples/csv-payments/orchestrator-svc/src/main/docker/Dockerfile.jvm
          tags: localhost/csv-payments/orchestrator-svc:latest
          load: true

      - name: Run Integration Tests
        env:
          MAVEN_ARGS: -B -T 1 -V --no-transfer-progress
        run: ./mvnw $MAVEN_ARGS verify

      - name: Dump integration test reports on failure
        if: failure()
        run: |
          echo "=== Failsafe reports ==="
          find . -path "*/target/failsafe-reports/*.txt" -print -exec tail -n 200 {} \;
          echo "=== Surefire reports ==="
          find . -path "*/target/surefire-reports/*.txt" -print -exec tail -n 200 {} \;

      - name: Upload test reports on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            **/target/surefire-reports/*.txt
            **/target/surefire-reports/*.xml
            **/target/failsafe-reports/*.txt
            **/target/failsafe-reports/*.xml
          retention-days: 7
          if-no-files-found: warn

      - name: Generate JaCoCo aggregate report
        if: github.event_name != 'pull_request'
        run: |
          # Build with coverage profile enabled to collect coverage data from unit tests only
          ./mvnw $MAVEN_ARGS clean verify -Pcoverage -DskipITs -DskipNative=true -Dquarkus.package.type=fast-jar

          # Generate an aggregated report (this will aggregate across all modules that produced coverage data)
          ./mvnw $MAVEN_ARGS org.jacoco:jacoco-maven-plugin:report-aggregate

      - name: Analyze with SonarQube
        if: github.event_name != 'pull_request'
        continue-on-error: true
        uses: sonarsource/sonarqube-scan-action@v6
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ vars.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.projectKey=${{ github.repository }}
            -Dsonar.organization=${{ github.repository_owner }}
            -Dsonar.projectName=${{ github.repository }}
            -Dsonar.projectVersion=${{ github.sha }}
            -Dsonar.sources=.
            -Dsonar.java.source=21
            -Dsonar.projectBaseDir=.
            -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco-aggregate/jacoco.xml
            -Dsonar.java.coveragePlugin=jacoco

      # Native builds
      - name: Setup GraalVM
        uses: graalvm/setup-graalvm@v1
        with:
          java-version: 21
          distribution: graalvm
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Maven for Native Builds
        run: |
          echo "MAVEN_ARGS=-B -T 1 -V -Dmaven.test.redirectTestOutputToFile=true --no-transfer-progress" >> $GITHUB_ENV

      - name: Full native build
        run: |
          ./mvnw $MAVEN_ARGS -DskipTests -Dquarkus.container-image.build=false -Dquarkus.native.enabled=true -Pnative package

      - name: Upload native orchestrator artifact
        uses: actions/upload-artifact@v4
        with:
          name: native-orchestrator-svc
          path: |
            examples/csv-payments/orchestrator-svc/target/*-runner
            examples/csv-payments/orchestrator-svc/target/*-runner.*
          retention-days: 7
          if-no-files-found: error

      - name: Upload native persistence artifact
        uses: actions/upload-artifact@v4
        with:
          name: native-persistence-svc
          path: |
            examples/csv-payments/persistence-svc/target/*-runner
            examples/csv-payments/persistence-svc/target/*-runner.*
          retention-days: 7
          if-no-files-found: error

      - name: Upload native input-csv artifact
        uses: actions/upload-artifact@v4
        with:
          name: native-input-csv-file-processing-svc
          path: |
            examples/csv-payments/input-csv-file-processing-svc/target/*-runner
            examples/csv-payments/input-csv-file-processing-svc/target/*-runner.*
          retention-days: 7
          if-no-files-found: error

      - name: Upload native payment-status artifact
        uses: actions/upload-artifact@v4
        with:
          name: native-payment-status-svc
          path: |
            examples/csv-payments/payment-status-svc/target/*-runner
            examples/csv-payments/payment-status-svc/target/*-runner.*
          retention-days: 7
          if-no-files-found: error

      - name: Upload native payments-processing artifact
        uses: actions/upload-artifact@v4
        with:
          name: native-payments-processing-svc
          path: |
            examples/csv-payments/payments-processing-svc/target/*-runner
            examples/csv-payments/payments-processing-svc/target/*-runner.*
          retention-days: 7
          if-no-files-found: error

      - name: Upload native output-csv artifact
        uses: actions/upload-artifact@v4
        with:
          name: native-output-csv-file-processing-svc
          path: |
            examples/csv-payments/output-csv-file-processing-svc/target/*-runner
            examples/csv-payments/output-csv-file-processing-svc/target/*-runner.*
          retention-days: 7
          if-no-files-found: error
