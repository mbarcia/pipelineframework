#!/bin/bash

# NOTE: If this file was generated by the browser-based template generator,
# run: chmod +x generate-dev-certs.sh

#
# Copyright (c) 2023-2025 Mariano Barcia
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

# Script to generate development certificates for quarkus:dev

ROOT_DIR="$(cd "$(dirname "$0")" && pwd)"
CERT_DIR="${ROOT_DIR}/target/dev-certs-tmp"
OUTPUT_DIR="${ROOT_DIR}/target/dev-certs"
rm -rf "${CERT_DIR}"
mkdir -p "${CERT_DIR}"

cat > "${CERT_DIR}/cert.conf" <<EOF
[req]
default_bits = 2048
prompt = no
default_md = sha256
distinguished_name = dn
req_extensions = v3_req

[dn]
C = US
ST = CA
L = San Francisco
O = {{appName}}
CN = localhost

[v3_req]
basicConstraints = CA:FALSE
keyUsage = nonRepudiation, digitalSignature, keyEncipherment
subjectAltName = @alt_names

[alt_names]
DNS.1 = localhost
IP.1 = 127.0.0.1
IP.2 = ::1
EOF

openssl req -x509 -newkey rsa:2048 -keyout "${CERT_DIR}/quarkus-key.pem" -out "${CERT_DIR}/quarkus-cert.pem" -days 365 -nodes -config "${CERT_DIR}/cert.conf" -extensions v3_req

openssl pkcs12 -export -in "${CERT_DIR}/quarkus-cert.pem" -inkey "${CERT_DIR}/quarkus-key.pem" -out "${CERT_DIR}/server-keystore.p12" -name server -passout pass:secret

keytool -import -file "${CERT_DIR}/quarkus-cert.pem" -keystore "${CERT_DIR}/client-truststore.jks" -storepass secret -noprompt -alias server

for svc in{{#if includePersistenceModule}} persistence-svc{{/if}}{{#each steps}} {{serviceName}}{{/each}}{{#if includeCacheInvalidationModule}} cache-invalidation-svc{{/if}} orchestrator-svc; do
    mkdir -p "${OUTPUT_DIR}/${svc}"
    cp "${CERT_DIR}/server-keystore.p12" "${OUTPUT_DIR}/${svc}/server-keystore.jks"
    chmod 644 "${OUTPUT_DIR}/${svc}/server-keystore.jks"
done

mkdir -p "${OUTPUT_DIR}/orchestrator-svc"
cp "${CERT_DIR}/client-truststore.jks" "${OUTPUT_DIR}/orchestrator-svc/client-truststore.jks"
chmod 644 "${OUTPUT_DIR}/orchestrator-svc/client-truststore.jks"

rm -rf "${CERT_DIR}"

echo "Development certificates generated successfully."
